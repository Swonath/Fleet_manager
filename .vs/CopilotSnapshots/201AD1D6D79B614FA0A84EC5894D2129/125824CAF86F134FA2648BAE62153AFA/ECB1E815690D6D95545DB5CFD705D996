-- ============================================
-- Script de création de la base de données
-- Fleet Manager - Gestion de parc automobile
-- ============================================

-- Créer la base de données
CREATE DATABASE IF NOT EXISTS fleet_manager;
USE fleet_manager;

-- ============================================
-- Table des utilisateurs
-- ============================================
CREATE TABLE utilisateurs (
    id_utilisateur INT PRIMARY KEY AUTO_INCREMENT,
    nom_utilisateur VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    mot_de_passe VARCHAR(255) NOT NULL,
    nom VARCHAR(100) NOT NULL,
    prenom VARCHAR(100) NOT NULL,
    role ENUM('administrateur', 'utilisateur') DEFAULT 'utilisateur',
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    actif BOOLEAN DEFAULT TRUE
);

-- ============================================
-- Table des véhicules
-- ============================================
CREATE TABLE vehicules (
    id_vehicule INT PRIMARY KEY AUTO_INCREMENT,
    marque VARCHAR(100) NOT NULL,
    modele VARCHAR(100) NOT NULL,
    immatriculation VARCHAR(20) UNIQUE NOT NULL,
    annee_fabrication INT NOT NULL,
    type_carburant ENUM('Essence', 'Diesel', 'Hybride', 'Électrique') NOT NULL,
    kilométrage_initial INT DEFAULT 0,
    kilométrage_actuel INT DEFAULT 0,
    date_acquisition DATE NOT NULL,
    etat ENUM('En service', 'En maintenance', 'Retiré du service') DEFAULT 'En service',
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    date_modification TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_immatriculation (immatriculation),
    INDEX idx_etat (etat)
);

-- ============================================
-- Table des carburants
-- ============================================
CREATE TABLE carburants (
    id_carburant INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_saisie DATE NOT NULL,
    heure_saisie TIME NOT NULL,
    quantite_litres DECIMAL(10, 2) NOT NULL,
    cout_total DECIMAL(10, 2) NOT NULL,
    cout_par_litre DECIMAL(10, 2) NOT NULL,
    kilométrage INT NOT NULL,
    notes VARCHAR(500),
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_saisie)
);

-- ============================================
-- Table des trajets (kilométrage)
-- ============================================
CREATE TABLE trajets (
    id_trajet INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_trajet DATE NOT NULL,
    heure_depart TIME NOT NULL,
    heure_arrivee TIME NOT NULL,
    kilométrage_depart INT NOT NULL,
    kilométrage_arrivee INT NOT NULL,
    distance_parcourue INT NOT NULL,
    lieu_depart VARCHAR(200) NOT NULL,
    lieu_arrivee VARCHAR(200) NOT NULL,
    type_trajet ENUM('Personnel', 'Professionnel', 'Service') DEFAULT 'Professionnel',
    notes VARCHAR(500),
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_trajet)
);

-- ============================================
-- Table des maintenances
-- ============================================
CREATE TABLE maintenances (
    id_maintenance INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_maintenance DATE NOT NULL,
    type_maintenance ENUM('Révision', 'Réparation', 'Révision contrôle technique', 'Changement pneus', 'Autre') NOT NULL,
    description VARCHAR(500) NOT NULL,
    cout_maintenance DECIMAL(10, 2) NOT NULL,
    fournisseur VARCHAR(200),
    kilométrage INT NOT NULL,
    date_prochaine_maintenance DATE,
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_maintenance)
);

-- ============================================
-- Table des rapports (pour cache des statistiques)
-- ============================================
CREATE TABLE rapports (
    id_rapport INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT,
    type_rapport ENUM('Consommation', 'Coûts', 'Utilisation', 'Maintenance', 'Global') NOT NULL,
    date_debut DATE NOT NULL,
    date_fin DATE NOT NULL,
    donnees_json JSON,
    date_generation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_utilisateur INT NOT NULL,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE SET NULL,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_generation)
);

-- ============================================
-- Données d'initialisation
-- ============================================

-- Insérer un utilisateur administrateur par défaut
INSERT INTO utilisateurs (nom_utilisateur, email, mot_de_passe, nom, prenom, role)
VALUES ('admin', 'admin@fleet-manager.com', 'admin123', 'Administrateur', 'Système', 'administrateur');

-- Insérer des véhicules de démonstration
INSERT INTO vehicules (marque, modele, immatriculation, annee_fabrication, type_carburant, date_acquisition, etat)
VALUES 
    ('Peugeot', '308', 'AB-123-CD', 2022, 'Essence', '2022-05-15', 'En service'),
    ('Renault', 'Espace', 'EF-456-GH', 2021, 'Diesel', '2021-03-20', 'En service'),
    ('Citroën', 'Berlingo', 'IJ-789-KL', 2020, 'Diesel', '2020-11-10', 'En service');

-- ============================================
-- Fin du script
-- ============================================
