using System.Collections.ObjectModel;
using System.Windows.Input;
using FLEET_MANAGER.Models;
using FLEET_MANAGER.Repositories;

namespace FLEET_MANAGER.ViewModels
{
    /// <summary>
    /// ViewModel pour la gestion du carburant
    /// </summary>
    public class CarburantViewModel : ViewModelBase
    {
        private ObservableCollection<Vehicule> _vehicules;
        private Vehicule? _vehiculeSelectionne;
        private ObservableCollection<Carburant> _historique;
        private decimal _quantiteLitres = 0;
        private decimal _coutTotal = 0;
        private decimal _coutParLitre = 0;
        private DateTime _dateSaisie = DateTime.Now;
        private int _kilometrage = 0;
        private string _notes = string.Empty;
        private string _messageErreur = string.Empty;
        private bool _isLoading = false;

        private VehiculeRepository _vehiculeRepository;
        private CarburantRepository _carburantRepository;

        public ObservableCollection<Vehicule> Vehicules
        {
            get => _vehicules;
            set => SetProperty(ref _vehicules, value, nameof(Vehicules));
        }

        public Vehicule? VehiculeSelectionne
        {
            get => _vehiculeSelectionne;
            set
            {
                if (SetProperty(ref _vehiculeSelectionne, value, nameof(VehiculeSelectionne)))
                {
                    if (value != null)
                    {
                        ChargerHistorique(value.IdVehicule);
                    }
                }
            }
        }

        public ObservableCollection<Carburant> Historique
        {
            get => _historique;
            set => SetProperty(ref _historique, value, nameof(Historique));
        }

        public decimal QuantiteLitres
        {
            get => _quantiteLitres;
            set
            {
                if (SetProperty(ref _quantiteLitres, value, nameof(QuantiteLitres)))
                {
                    CalculerCoutParLitre();
                }
            }
        }

        public decimal CoutTotal
        {
            get => _coutTotal;
            set
            {
                if (SetProperty(ref _coutTotal, value, nameof(CoutTotal)))
                {
                    CalculerCoutParLitre();
                }
            }
        }

        public decimal CoutParLitre
        {
            get => _coutParLitre;
            set => SetProperty(ref _coutParLitre, value, nameof(CoutParLitre));
        }

        public DateTime DateSaisie
        {
            get => _dateSaisie;
            set => SetProperty(ref _dateSaisie, value, nameof(DateSaisie));
        }

        public int Kilometrage
        {
            get => _kilometrage;
            set => SetProperty(ref _kilometrage, value, nameof(Kilometrage));
        }

        public string Notes
        {
            get => _notes;
            set => SetProperty(ref _notes, value, nameof(Notes));
        }

        public string MessageErreur
        {
            get => _messageErreur;
            set => SetProperty(ref _messageErreur, value, nameof(MessageErreur));
        }

        public bool IsLoading
        {
            get => _isLoading;
            set => SetProperty(ref _isLoading, value, nameof(IsLoading));
        }

        // Commandes
        public ICommand EnregistrerCommand { get; }
        public ICommand ReinitialiserCommand { get; }

        public CarburantViewModel()
        {
            _vehicules = new ObservableCollection<Vehicule>();
            _historique = new ObservableCollection<Carburant>();
            _vehiculeRepository = new VehiculeRepository();
            _carburantRepository = new CarburantRepository();

            EnregistrerCommand = new RelayCommand(_ => PerformerEnregistrement(), _ => VehiculeSelectionne != null && !IsLoading);
            ReinitialiserCommand = new RelayCommand(_ => Reinitialiser());

            ChargerVehicules();
        }

        private void ChargerVehicules()
        {
            try
            {
                var vehicules = _vehiculeRepository.ObtenirTousLesVehicules();
                Vehicules = new ObservableCollection<Vehicule>(vehicules);
                MessageErreur = string.Empty;
            }
            catch (Exception ex)
            {
                MessageErreur = $"Erreur lors du chargement des vehicules : {ex.Message}";
                System.Diagnostics.Debug.WriteLine(MessageErreur);
            }
        }

        private void ChargerHistorique(int idVehicule)
        {
            try
            {
                var historique = _carburantRepository.ObtenirCarburantParVehicule(idVehicule);
                Historique = new ObservableCollection<Carburant>(historique);
            }
            catch (Exception ex)
            {
                MessageErreur = $"Erreur lors du chargement de l'historique : {ex.Message}";
            }
        }

        private void PerformerEnregistrement()
        {
            if (VehiculeSelectionne == null)
            {
                MessageErreur = "Veuillez selectionner un vehicule.";
                return;
            }

            if (QuantiteLitres <= 0)
            {
                MessageErreur = "La quantite doit etre superieure a 0.";
                return;
            }

            if (CoutTotal <= 0)
            {
                MessageErreur = "Le cout doit etre superieur a 0.";
                return;
            }

            if (Kilometrage <= 0)
            {
                MessageErreur = "Le kilometrage doit etre superieur a 0.";
                return;
            }

            try
            {
                IsLoading = true;

                var carburant = new Carburant
                {
                    IdVehicule = VehiculeSelectionne.IdVehicule,
                    DateSaisie = DateSaisie,
                    QuantiteLitres = QuantiteLitres,
                    CoutTotal = CoutTotal,
                    CoutParLitre = CoutParLitre,
                    Kilométrage = Kilometrage,
                    Notes = Notes,
                    IdUtilisateur = 1  // TODO: Utiliser l'utilisateur connecte
                };

                if (_carburantRepository.AjouterCarburant(carburant))
                {
                    MessageErreur = "Ravitaillement enregistre avec succes !";
                    ChargerHistorique(VehiculeSelectionne.IdVehicule);
                    Reinitialiser();
                }
                else
                {
                    MessageErreur = "Erreur lors de l'enregistrement.";
                }
            }
            catch (Exception ex)
            {
                MessageErreur = $"Erreur : {ex.Message}";
            }
            finally
            {
                IsLoading = false;
            }
        }

        private void CalculerCoutParLitre()
        {
            if (QuantiteLitres > 0 && CoutTotal > 0)
            {
                CoutParLitre = CoutTotal / QuantiteLitres;
            }
        }

        private void Reinitialiser()
        {
            QuantiteLitres = 0;
            CoutTotal = 0;
            CoutParLitre = 0;
            DateSaisie = DateTime.Now;
            Kilometrage = 0;
            Notes = string.Empty;
        }
    }
}
