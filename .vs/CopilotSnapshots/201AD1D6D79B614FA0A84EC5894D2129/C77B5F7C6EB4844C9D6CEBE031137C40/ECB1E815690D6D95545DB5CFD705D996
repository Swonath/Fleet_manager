-- ============================================
-- Script de création de la base de données
-- Fleet Manager - Gestion de parc automobile
-- ============================================

-- Créer la base de données
CREATE DATABASE IF NOT EXISTS fleet_manager;
USE fleet_manager;

-- ============================================
-- Table des utilisateurs
-- ============================================
CREATE TABLE utilisateurs (
    id_utilisateur INT PRIMARY KEY AUTO_INCREMENT,
    nom_utilisateur VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    mot_de_passe VARCHAR(255) NOT NULL,
    nom VARCHAR(100) NOT NULL,
    prenom VARCHAR(100) NOT NULL,
    role ENUM('administrateur', 'utilisateur') DEFAULT 'utilisateur',
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    actif BOOLEAN DEFAULT TRUE
);

-- ============================================
-- Table des véhicules
-- ============================================
CREATE TABLE vehicules (
    id_vehicule INT PRIMARY KEY AUTO_INCREMENT,
    marque VARCHAR(100) NOT NULL,
    modele VARCHAR(100) NOT NULL,
    immatriculation VARCHAR(20) UNIQUE NOT NULL,
    annee_fabrication INT NOT NULL,
    type_carburant ENUM('Essence', 'Diesel', 'Hybride', 'Électrique') NOT NULL,
    kilométrage_initial INT DEFAULT 0,
    kilométrage_actuel INT DEFAULT 0,
    date_acquisition DATE NOT NULL,
    etat ENUM('En service', 'En maintenance', 'Retiré du service') DEFAULT 'En service',
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    date_modification TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_immatriculation (immatriculation),
    INDEX idx_etat (etat)
);

-- ============================================
-- Table des carburants
-- ============================================
CREATE TABLE carburants (
    id_carburant INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_saisie DATE NOT NULL,
    heure_saisie TIME NOT NULL,
    quantite_litres DECIMAL(10, 2) NOT NULL,
    cout_total DECIMAL(10, 2) NOT NULL,
    cout_par_litre DECIMAL(10, 2) NOT NULL,
    kilométrage INT NOT NULL,
    notes VARCHAR(500),
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_saisie)
);

-- ============================================
-- Table des trajets (kilométrage)
-- ============================================
CREATE TABLE trajets (
    id_trajet INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_trajet DATE NOT NULL,
    heure_depart TIME NOT NULL,
    heure_arrivee TIME NOT NULL,
    kilométrage_depart INT NOT NULL,
    kilométrage_arrivee INT NOT NULL,
    distance_parcourue INT NOT NULL,
    lieu_depart VARCHAR(200) NOT NULL,
    lieu_arrivee VARCHAR(200) NOT NULL,
    type_trajet ENUM('Personnel', 'Professionnel', 'Service') DEFAULT 'Professionnel',
    notes VARCHAR(500),
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_trajet)
);

-- ============================================
-- Table des maintenances
-- ============================================
CREATE TABLE maintenances (
    id_maintenance INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT NOT NULL,
    date_maintenance DATE NOT NULL,
    type_maintenance ENUM('Révision', 'Réparation', 'Révision contrôle technique', 'Changement pneus', 'Autre') NOT NULL,
    description VARCHAR(500) NOT NULL,
    cout_maintenance DECIMAL(10, 2) NOT NULL,
    fournisseur VARCHAR(200),
    kilométrage INT NOT NULL,
    date_prochaine_maintenance DATE,
    id_utilisateur INT NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE CASCADE,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_maintenance)
);

-- ============================================
-- Table des rapports (pour cache des statistiques)
-- ============================================
CREATE TABLE rapports (
    id_rapport INT PRIMARY KEY AUTO_INCREMENT,
    id_vehicule INT,
    type_rapport ENUM('Consommation', 'Coûts', 'Utilisation', 'Maintenance', 'Global') NOT NULL,
    date_debut DATE NOT NULL,
    date_fin DATE NOT NULL,
    donnees_json JSON,
    date_generation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_utilisateur INT NOT NULL,
    FOREIGN KEY (id_vehicule) REFERENCES vehicules(id_vehicule) ON DELETE SET NULL,
    FOREIGN KEY (id_utilisateur) REFERENCES utilisateurs(id_utilisateur) ON DELETE RESTRICT,
    INDEX idx_vehicule (id_vehicule),
    INDEX idx_date (date_generation)
);

-- ============================================
-- Données d'initialisation
-- ============================================

-- Insérer un utilisateur administrateur par défaut
INSERT INTO utilisateurs (nom_utilisateur, email, mot_de_passe, nom, prenom, role)
VALUES ('admin', 'admin@fleet-manager.com', 'admin123', 'Administrateur', 'Système', 'administrateur');

-- Insérer des utilisateurs supplémentaires
INSERT INTO utilisateurs (nom_utilisateur, email, mot_de_passe, nom, prenom, role)
VALUES 
    ('marie_dupont', 'marie.dupont@company.com', 'pass123', 'Dupont', 'Marie', 'utilisateur'),
    ('jean_martin', 'jean.martin@company.com', 'pass123', 'Martin', 'Jean', 'utilisateur'),
    ('sophie_bernard', 'sophie.bernard@company.com', 'pass123', 'Bernard', 'Sophie', 'utilisateur');

-- Insérer des véhicules de démonstration
INSERT INTO vehicules (marque, modele, immatriculation, annee_fabrication, type_carburant, kilométrage_initial, kilométrage_actuel, date_acquisition, etat)
VALUES 
    ('Peugeot', '308', 'AB-123-CD', 2022, 'Essence', 15000, 45320, '2022-05-15', 'En service'),
    ('Renault', 'Espace', 'EF-456-GH', 2021, 'Diesel', 20000, 72840, '2021-03-20', 'En service'),
    ('Citroën', 'Berlingo', 'IJ-789-KL', 2020, 'Diesel', 10000, 125450, '2020-11-10', 'En service'),
    ('Volkswagen', 'Transporter', 'MN-012-OP', 2023, 'Diesel', 5000, 18900, '2023-01-10', 'En service'),
    ('Toyota', 'Yaris', 'QR-345-ST', 2022, 'Essence', 8000, 35670, '2022-08-20', 'En maintenance');

-- ============================================
-- Données de carburant (Ravitaillements)
-- ============================================
-- Peugeot 308 (id_vehicule = 1)
INSERT INTO carburants (id_vehicule, date_saisie, heure_saisie, quantite_litres, cout_total, cout_par_litre, kilométrage, notes, id_utilisateur)
VALUES 
    (1, '2025-10-01', '09:30:00', 50.0, 82.50, 1.65, 40000, 'Ravitaillement prévu', 1),
    (1, '2025-10-15', '14:15:00', 45.0, 74.25, 1.65, 42150, 'Plein complet', 2),
    (1, '2025-10-28', '11:00:00', 52.0, 85.80, 1.65, 44890, 'Avant long trajet', 1),
    (1, '2025-11-05', '16:45:00', 48.0, 79.20, 1.65, 45320, 'Entretien régulier', 3);

-- Renault Espace (id_vehicule = 2)
INSERT INTO carburants (id_vehicule, date_saisie, heure_saisie, quantite_litres, cout_total, cout_par_litre, kilométrage, notes, id_utilisateur)
VALUES 
    (2, '2025-10-02', '08:00:00', 60.0, 99.00, 1.65, 70000, 'Plein complet', 2),
    (2, '2025-10-18', '13:30:00', 58.0, 95.70, 1.65, 71200, 'Ravitaillement', 1),
    (2, '2025-10-30', '10:20:00', 62.0, 102.30, 1.65, 72840, 'Avant trajet', 3);

-- Citroën Berlingo (id_vehicule = 3)
INSERT INTO carburants (id_vehicule, date_saisie, heure_saisie, quantite_litres, cout_total, cout_par_litre, kilométrage, notes, id_utilisateur)
VALUES 
    (3, '2025-09-25', '07:15:00', 70.0, 115.50, 1.65, 123000, 'Plein complet', 1),
    (3, '2025-10-10', '15:45:00', 68.0, 112.20, 1.65, 124500, 'Ravitaillement utilitaire', 2),
    (3, '2025-10-22', '09:30:00', 72.0, 118.80, 1.65, 125450, 'Entretien flotte', 3);

-- Volkswagen Transporter (id_vehicule = 4)
INSERT INTO carburants (id_vehicule, date_saisie, heure_saisie, quantite_litres, cout_total, cout_par_litre, kilométrage, notes, id_utilisateur)
VALUES 
    (4, '2025-10-05', '10:00:00', 55.0, 90.75, 1.65, 18000, 'Premier ravitaillement', 1),
    (4, '2025-10-20', '14:30:00', 58.0, 95.70, 1.65, 18900, 'Plein complet', 2);

-- Toyota Yaris (id_vehicule = 5)
INSERT INTO carburants (id_vehicule, date_saisie, heure_saisie, quantite_litres, cout_total, cout_par_litre, kilométrage, notes, id_utilisateur)
VALUES 
    (5, '2025-10-03', '11:15:00', 42.0, 69.30, 1.65, 35000, 'Ravitaillement', 3),
    (5, '2025-10-19', '16:00:00', 40.0, 66.00, 1.65, 35670, 'Plein avant maintenance', 1);

-- ============================================
-- Données de trajets
-- ============================================
-- Peugeot 308 (id_vehicule = 1)
INSERT INTO trajets (id_vehicule, date_trajet, heure_depart, heure_arrivee, kilométrage_depart, kilométrage_arrivee, distance_parcourue, lieu_depart, lieu_arrivee, type_trajet, notes, id_utilisateur)
VALUES 
    (1, '2025-10-01', '08:00:00', '09:30:00', 40000, 40085, 85, 'Siège social', 'Client A - Paris', 'Professionnel', 'Visite client', 1),
    (1, '2025-10-02', '09:45:00', '11:15:00', 40085, 40150, 65, 'Client A', 'Bureau régional', 'Professionnel', 'Réunion', 2),
    (1, '2025-10-07', '14:00:00', '16:30:00', 42000, 42120, 120, 'Domicile', 'Centre commercial', 'Personnel', 'Courses', 1),
    (1, '2025-10-15', '07:30:00', '11:00:00', 42150, 42380, 230, 'Siège social', 'Client B - Lyon', 'Professionnel', 'Long trajet client', 3),
    (1, '2025-10-25', '10:00:00', '14:00:00', 44500, 44890, 390, 'Siège social', 'Conférence - Marseille', 'Professionnel', 'Trajet professionnel', 2);

-- Renault Espace (id_vehicule = 2)
INSERT INTO trajets (id_vehicule, date_trajet, heure_depart, heure_arrivee, kilométrage_depart, kilométrage_arrivee, distance_parcourue, lieu_depart, lieu_arrivee, type_trajet, notes, id_utilisateur)
VALUES 
    (2, '2025-10-01', '09:00:00', '10:30:00', 70000, 70120, 120, 'Siège', 'Client principal', 'Professionnel', 'Visite de routine', 2),
    (2, '2025-10-08', '13:00:00', '17:30:00', 70800, 71200, 400, 'Domicile', 'Vacances - Côte d''Azur', 'Personnel', 'Sortie famille', 1),
    (2, '2025-10-18', '08:30:00', '10:15:00', 71200, 71320, 120, 'Domicile', 'Bureau', 'Professionnel', 'Trajet domicile-travail', 3),
    (2, '2025-10-28', '10:00:00', '16:00:00', 72000, 72840, 840, 'Siège social', 'Congrès - Bordeaux', 'Professionnel', 'Long déplacement', 2);

-- Citroën Berlingo (id_vehicule = 3)
INSERT INTO trajets (id_vehicule, date_trajet, heure_depart, heure_arrivee, kilométrage_depart, kilométrage_arrivee, distance_parcourue, lieu_depart, lieu_arrivee, type_trajet, notes, id_utilisateur)
VALUES 
    (3, '2025-09-25', '06:00:00', '07:45:00', 123000, 123120, 120, 'Dépôt', 'Première livraison', 'Professionnel', 'Tournée de livraison', 1),
    (3, '2025-09-26', '06:30:00', '17:00:00', 123120, 123850, 730, 'Dépôt', 'Tournée complète', 'Professionnel', 'Journée complète livraison', 3),
    (3, '2025-10-10', '07:00:00', '16:30:00', 124500, 124950, 450, 'Dépôt', 'Livraisons régionales', 'Professionnel', 'Tournée', 2),
    (3, '2025-10-22', '06:00:00', '18:00:00', 124950, 125450, 500, 'Dépôt', 'Tournée longue distance', 'Service', 'Livraisons spéciales', 1);

-- Volkswagen Transporter (id_vehicule = 4)
INSERT INTO trajets (id_vehicule, date_trajet, heure_depart, heure_arrivee, kilométrage_depart, kilométrage_arrivee, distance_parcourue, lieu_depart, lieu_arrivee, type_trajet, notes, id_utilisateur)
VALUES 
    (4, '2025-10-05', '08:00:00', '09:30:00', 18000, 18080, 80, 'Dépôt', 'Client 1', 'Service', 'Première utilisation', 2),
    (4, '2025-10-15', '07:00:00', '17:30:00', 18080, 18900, 820, 'Dépôt', 'Tournée multi-sites', 'Service', 'Journée complète', 1);

-- Toyota Yaris (id_vehicule = 5)
INSERT INTO trajets (id_vehicule, date_trajet, heure_depart, heure_arrivee, kilométrage_depart, kilométrage_arrivee, distance_parcourue, lieu_depart, lieu_arrivee, type_trajet, notes, id_utilisateur)
VALUES 
    (5, '2025-10-03', '09:00:00', '10:30:00', 35000, 35120, 120, 'Siège', 'Client proche', 'Professionnel', 'Visite client', 3),
    (5, '2025-10-10', '14:00:00', '18:00:00', 35300, 35670, 370, 'Domicile', 'Balades touristiques', 'Personnel', 'Sortie', 1);

-- ============================================
-- Données de maintenances
-- ============================================
-- Peugeot 308 (id_vehicule = 1)
INSERT INTO maintenances (id_vehicule, date_maintenance, type_maintenance, description, cout_maintenance, fournisseur, kilométrage, date_prochaine_maintenance, id_utilisateur)
VALUES 
    (1, '2025-08-15', 'Révision', 'Révision 40000 km - Vidange, filtres', 250.00, 'Garage Peugeot Paris', 40000, '2025-11-15', 1),
    (1, '2025-09-10', 'Changement pneus', 'Changement pneus d''été en hiver', 320.00, 'Michelin Centre Auto', 42000, '2026-04-15', 2),
    (1, '2025-09-25', 'Réparation', 'Remplacement plaquettes de frein', 180.00, 'Garage Local', 42500, NULL, 1);

-- Renault Espace (id_vehicule = 2)
INSERT INTO maintenances (id_vehicule, date_maintenance, type_maintenance, description, cout_maintenance, fournisseur, kilométrage, date_prochaine_maintenance, id_utilisateur)
VALUES 
    (2, '2025-07-20', 'Révision', 'Révision 60000 km - Entretien complet', 350.00, 'Renault Service', 60000, '2025-12-20', 2),
    (2, '2025-08-30', 'Révision contrôle technique', 'Contrôle technique annuel', 85.00, 'Centre Technique Agréé', 68000, '2026-08-30', 1),
    (2, '2025-09-15', 'Réparation', 'Remplacement amortisseur avant droit', 450.00, 'Garage Renault', 70000, NULL, 3);

-- Citroën Berlingo (id_vehicule = 3)
INSERT INTO maintenances (id_vehicule, date_maintenance, type_maintenance, description, cout_maintenance, fournisseur, kilométrage, date_prochaine_maintenance, id_utilisateur)
VALUES 
    (3, '2025-06-10', 'Révision', 'Révision 120000 km - Vidange moteur', 280.00, 'Garage Citroën Marseille', 120000, '2025-11-10', 1),
    (3, '2025-07-25', 'Changement pneus', 'Changement complet pneus usés', 450.00, 'Michelin Pro', 121500, '2026-07-25', 2),
    (3, '2025-09-05', 'Révision contrôle technique', 'Contrôle technique tous les 2 ans', 110.00, 'Centre Technique Agréé', 124000, '2027-09-05', 1),
    (3, '2025-10-15', 'Réparation', 'Réparation batterie', 120.00, 'Garage Local', 125000, NULL, 3);

-- Volkswagen Transporter (id_vehicule = 4)
INSERT INTO maintenances (id_vehicule, date_maintenance, type_maintenance, description, cout_maintenance, fournisseur, kilométrage, date_prochaine_maintenance, id_utilisateur)
VALUES 
    (4, '2023-05-20', 'Révision', 'Révision 10000 km - Entretien neuf véhicule', 200.00, 'Volkswagen Service', 10000, '2024-05-20', 1);

-- Toyota Yaris (id_vehicule = 5)
INSERT INTO maintenances (id_vehicule, date_maintenance, type_maintenance, description, cout_maintenance, fournisseur, kilométrage, date_prochaine_maintenance, id_utilisateur)
VALUES 
    (5, '2025-09-20', 'Révision', 'Révision 30000 km - Entretien prévu', 220.00, 'Toyota Service', 30000, '2025-12-20', 2),
    (5, '2025-10-10', 'Réparation', 'Maintenance en cours avant utilisation', 150.00, 'Garage Toyota', 35000, NULL, 1);

-- ============================================
-- Données de rapports (statistiques générées)
-- ============================================
-- Rapport consommation Peugeot 308 (septembre-octobre 2025)
INSERT INTO rapports (id_vehicule, type_rapport, date_debut, date_fin, donnees_json, id_utilisateur)
VALUES 
    (1, 'Consommation', '2025-09-01', '2025-10-31', '{"total_litres": 195, "total_km": 1770, "consommation_moyenne": 11.0, "cout_moyen_litre": 1.65}', 1),
    (2, 'Consommation', '2025-09-01', '2025-10-31', '{"total_litres": 180, "total_km": 2840, "consommation_moyenne": 15.8, "cout_moyen_litre": 1.65}', 1),
    (3, 'Consommation', '2025-09-01', '2025-10-31', '{"total_litres": 210, "total_km": 2450, "consommation_moyenne": 11.7, "cout_moyen_litre": 1.65}', 1),
    (4, 'Consommation', '2025-10-01', '2025-10-31', '{"total_litres": 113, "total_km": 900, "consommation_moyenne": 8.0, "cout_moyen_litre": 1.65}', 1),
    (5, 'Consommation', '2025-10-01', '2025-10-31', '{"total_litres": 82, "total_km": 670, "consommation_moyenne": 8.2, "cout_moyen_litre": 1.65}', 1);

-- Rapport coûts (septembre-octobre 2025)
INSERT INTO rapports (id_vehicule, type_rapport, date_debut, date_fin, donnees_json, id_utilisateur)
VALUES 
    (1, 'Coûts', '2025-09-01', '2025-10-31', '{"cout_carburant": 321.75, "cout_maintenance": 430.00, "cout_total": 751.75, "cout_km": 0.42}', 1),
    (2, 'Coûts', '2025-09-01', '2025-10-31', '{"cout_carburant": 297.00, "cout_maintenance": 835.00, "cout_total": 1132.00, "cout_km": 0.40}', 1),
    (3, 'Coûts', '2025-09-01', '2025-10-31', '{"cout_carburant": 346.50, "cout_maintenance": 960.00, "cout_total": 1306.50, "cout_km": 0.53}', 1);

-- Rapport utilisation flotte (octobre 2025)
INSERT INTO rapports (id_vehicule, type_rapport, date_debut, date_fin, donnees_json, id_utilisateur)
VALUES 
    (NULL, 'Global', '2025-10-01', '2025-10-31', '{"total_vehicules": 5, "total_km": 6430, "total_carburant_litres": 815, "cout_total_carburant": 1344.75, "cout_maintenance": 1145.00, "utilisation_moyenne_percent": 78}', 1);

-- Rapport maintenance (global)
INSERT INTO rapports (id_vehicule, type_rapport, date_debut, date_fin, donnees_json, id_utilisateur)
VALUES 
    (NULL, 'Maintenance', '2025-01-01', '2025-10-31', '{"interventions_total": 11, "cout_total": 3430.00, "vehicule_maintenance": 1, "cout_moyen_intervention": 311.82, "prochaine_revision": "2025-11-15"}', 1);

-- ============================================
-- Fin du script
-- ============================================
